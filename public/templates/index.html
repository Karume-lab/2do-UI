<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="shortcut icon" href="./../img/icons/favicon.png" type="image/x-icon">
	<title>2DO | Home</title>
</head>

<body class="md:bg-center bg-no-repeat bg-cover" style="background-image: url(./../img/todo-bg.jpg)">

	<!-- Page Wrapper -->
	<div class="relative">
		<h1 class="text-center py-2 underline text-xl md:text-6xl">2DO</h1>

		<!-- Content Wrapper -->
		<div class="p-4 mx-3 border border-black rounded-xl flex h-screen">

			<!-- Task Wrapper -->
			<div id="tasksWrapper" class="border border-black bg-black bg-opacity-25 rounded-xl p-2 md:w-5/12 flex flex-col">

				<!-- Wrapper Top -->
				<div class="flex items-center justify-between">

					<!-- Wrapper Icon -->
					<button>
						<img src="./../img/icons/tasks.png" alt="" class="w-10 h-10 md:w-20	 md:h-20	">
					</button>
					<!-- Wrapper Icon End -->

					<!-- Actions -->
					<div class="flex items-center justify-center bg-lime-600 bg-opacity-40 rounded-r-full rounded-l-full">

						<!-- Dropside Options -->
						<div id="tasksDropsideOptions" class="p-1 hidden">
							<button id="addTask" data-modal="addTaskModal" class="p-2"><img src="./../img/icons/add.png" alt=""
									class="w-10 h-10 md:w-20 md:h-20"></button>
							<div class="border border-black m-3"></div>

							<div>
								<div>
									<span id="selectedTasksNo" class="rounded-full bg-white bg-opacity-80 shadow-xl"></span>
								</div>
								<div class="flex bg-black bg-opacity-80 rounded-xl p-2">
									<button onclick="deleteSelectedTasks()">
										<img src="./../img/icons/delete.png" alt="" class="w-10 h-10 md:w-20 md:h-20">
									</button>
									<button onclick="markSelectedTasks()">
										<img src="./../img/icons/complete.png" alt="" class="w-10 h-10 md:w-20 md:h-20">
									</button>
								</div>
							</div>

							<button onclick="deleteAllTasks()"><img src="./../img/icons/delete.png" alt="" class="w-10 h-10 md:w-20 md:h-20"></button>
							<button onclick="markAllTasks()"><img src="./../img/icons/complete.png" alt="" class="w-10 h-10 md:w-20 md:h-20"></button>
						</div>
						<!-- Dropside Options End -->

						<div id="tasksDropsideToggler">
							<button id="openTasksMenu" class="p-2"><img src="./../img/icons/dropside.png" alt=""
									class="bg-white rounded-full w-10 h-10 md:w-20 md:h-20"></button>
							<button id="closeTasksMenu" class="p-2 hidden"><img src="./../img/icons/close.png" alt=""
									class="bg-white rounded-full w-10 h-10 md:w-20 md:h-20"></button>
						</div>
					</div>
					<!-- Actions End -->

				</div>
				<!-- Wrapper Top End -->

				<!-- Progress Bar -->
				<div class="border border-black w-96">
					<div id="progressBar" class="p-3 bg-red-600"></div>
				</div>
				<!-- Progress Bar End -->

				<!-- Task Details -->
				<div class="mt-5 px-2">
					<ul id="tasksUl"></ul>
				</div>
				<!-- Task Details End -->

			</div>
			<!-- Task Wrapper End -->

			<!-- Steps Wrapper -->
			<div id="stepsWrapper"
				class="border border-black bg-black bg-opacity-25 rounded-xl p-2 md:w-7/12 ml-4 flex flex-col">

				<!-- Wrapper Top -->
				<div class="flex items-center justify-between">

					<!-- Wrapper Icon -->
					<button>
						<img src="./../img/icons/steps.png" alt="" class="w-10 h-10 md:w-20	 md:h-20">
					</button>
					<!-- Wrapper Icon End -->

					<!-- Actions -->
					<div class="flex items-center justify-center bg-lime-600 bg-opacity-40 rounded-r-full rounded-l-full">

						<!-- Dropside Options -->
						<div id="stepsDropsideOptions" class="p-1 hidden">
							<button disabled id="addStepBtn" data-modal="addStepModal" class="p-2 cursor-not-allowed">
								<img src="./../img/icons/add.png" alt="" class="w-10 h-10 md:w-20 md:h-20">
							</button>
							<div class="border border-black"></div>
							<button onclick="deleteSelectedSteps()"><img src="./../img/icons/delete.png" alt="" class="w-10 h-10 md:w-20 md:h-20"></button>
							<button onclick="markSelectedSteps()"><img src="./../img/icons/complete.png" alt="" class="w-10 h-10 md:w-20 md:h-20"></button>
							<button onclick="deleteAllSteps()"><img src="./../img/icons/delete.png" alt="" class="w-10 h-10 md:w-20 md:h-20"></button>
							<button onclick="markAllSteps()"><img src="./../img/icons/complete.png" alt="" class="w-10 h-10 md:w-20 md:h-20"></button>
						</div>
						<!-- Dropside Options End -->

						<div id="stepsDropsideToggler">
							<button id="openStepsMenu" class="p-2"><img src="./../img/icons/dropside.png" alt=""
									class="bg-white rounded-full w-10 h-10 md:w-20 md:h-20"></button>
							<button id="closeStepsMenu" class="p-2 hidden"><img src="./../img/icons/close.png" alt=""
									class="bg-white rounded-full w-10 h-10 md:w-20 md:h-20"></button>
						</div>
					</div>
					<!-- Actions End -->

				</div>
				<!-- Wrapper Top End -->

				<div>

					<!-- No Task Clicked Info -->
					<div id="clickTask" class="text-center md:text-4xl">
						<h1>CLICK ON A TASK TO SHOW THE STEPS</h1>
					</div>
					<!-- No Task Clicked Info End -->

					<!-- Steps Details -->
					<div id="stepsDiv">
						<ul id="stepsUl"></ul>
					</div>
					<!-- Steps Details End -->

				</div>
			</div>
			<!-- Steps Wrapper End -->

		</div>
		<!-- Content Wrapper End -->

	</div>
	<!-- Page Wrapper End -->

	<!-- Add Task Modal -->
	<div id="addTaskModal" class="fixed inset-0 items-center justify-center z-10 hidden">
		<div class="w-fit bg-gray-500 shadow-lg m-2 rounded-xl">
			<div class="flex justify-between items-center px-3">
				<span class="w-20 h-20"><img src="./../img/icons/new-task.png" alt=""></span>
				<button data-modal="addTaskModal" class="text-6xl">&times;</button>
			</div>
			<div class="pb-2">
				<div class="flex flex-col w-fit p-3 mb-2">
					<label for="taskTitle">Title</label>
					<input type="text" name="taskTitle" id="taskTitle" class="rounded-lg p-3">
					<label for="taskDescription">Description</label>
					<textarea name="taskDescription" id="taskDescription" cols="30" rows="10" class="rounded-xl p-4"></textarea>
				</div>
				<div class="flex justify-around">
					<button class="p-2 rounded-lg bg-red-700 hover:bg-red-600">Clear</button>
					<button onclick="addTask()" class="p-2 bg-green-700 hover:bg-green-600 rounded-lg">Add Task</button>
				</div>
			</div>
		</div>
	</div>
	<!-- Add Task Modal End -->

	<!-- Add Step Modal -->
	<div id="addStepModal" class="fixed inset-0 items-center justify-center z-10 hidden">
		<div class="w-fit bg-gray-500 shadow-lg m-2 rounded-xl">
			<div class="flex justify-between items-center px-3">
				<span class="w-20 h-20"><img src="./../img/icons/new-step.png" alt=""></span>
				<button data-modal="addStepModal" class="text-6xl">&times;</button>
			</div>
			<div action="" class="pb-2">
				<div class="flex flex-col w-fit p-3 mb-2">
					<label for="stepDescription">Description</label>
					<textarea name="stepDescription" id="stepDescription" cols="30" rows="10" class="rounded-xl p-4"></textarea>
				</div>
				<div class="flex justify-around">
					<button class="p-2 rounded-lg bg-red-700 hover:bg-red-600">Clear</button>
					<button onclick="addStep()" class="p-2 bg-green-700 hover:bg-green-600 rounded-lg">Add Step</button>
				</div>
			</div>
		</div>
	</div>
	<!-- Add Step Modal End -->

	<!-- Footer -->
	<!-- <footer class="bg-green-500 absolute bottom-0 w-full p-1">
			<div class="text-center">
				<span>2DO &copy 2023</span>
			</div>
			<div>
				SOCIAL ICONS
			</div>
		</footer> -->
	<!-- Footer End -->

	<script>
		let selectedTaskArray = [];

		window.addEventListener("load", () => {
			displayTasksHTML(taskArray);
		
			const taskNoSpan = document.querySelector("#selectedTasksNo");
		
			taskArray.forEach(task => {
				if (task.is_selected) {
					selectedTaskArray.push(task);
				}
			});
			
			if (selectedTaskArray.length > 0) {
				taskNoSpan.innerHTML = selectedTaskArray.length;
				taskNoSpan.classList.add("p-2");
			} else {
				taskNoSpan.innerHTML = "";
				taskNoSpan.classList.remove("p-2");
			}
		});

		

		let taskArray = localStorage.getItem("tasks")
		? JSON.parse(localStorage.getItem("tasks"))
		: [];
		let selectedTaskId = "";
		let selectedTaskIdArray = [];
		let selectedStepIndexArray = [];
		
		const storeTask = (title, description) => {
			const id = taskArray.length;
			const task = {
				id: id,
				title: `${title}`,
				description: `${description}`,
				checked: false,
				is_selected: false,
				steps: [],
			};
		
			taskArray.push(task);
			localStorage.setItem("tasks", JSON.stringify(taskArray));
		};
		
		const storeStep = (description) => {
			const task = document.querySelector(`#${selectedTaskId}`);
			const step = {
				description: `${description}`,
				checked: false,
				is_selected: false,
			}
			taskArray[task.id.replace("task", "") - 1].steps.push(step);
			localStorage.setItem("tasks", JSON.stringify(taskArray));
		}
		
		const deleteAllTasks = () => {
			localStorage.setItem("tasks", []);
			location.reload();
		}
		
		const markAllTasks = () => {
			taskArray.forEach(task => {
				task.checked = true;
			});
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		
		const deleteAllSteps = () => {
			const task = taskArray[selectedTaskId.replace("task", "") - 1];
			task.steps = [];
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		
		const markAllSteps = () => {
			const steps = taskArray[selectedTaskId.replace("task", "") - 1].steps;
			steps.forEach(step => {
				step.checked = true;
			});
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		
		const deleteSelectedTasks = () => {
			const newTaskArray = taskArray.slice(0, taskArray.length);
			const selectedTaskIdArray = []
		
			selectedTaskArray.forEach(sTask => {
				taskArray.forEach((task, index) => {
					if (sTask === task) {
						selectedTaskIdArray.push(index);
					}
				});
			});
		
			taskArray.forEach(task => {
				selectedTaskIdArray.forEach((sTask, index) => {
					if (task === taskArray[sTask]) {
						newTaskArray.splice(sTask - index, 1);
					}
				});
			});
		
			localStorage.setItem("tasks", JSON.stringify(newTaskArray));
			location.reload();
		}
		
		const deleteSelectedSteps = () => {
			const newStepArray = [];
			const task = taskArray[selectedTaskId.replace("task", "") - 1];
		
			task.steps.forEach(step => {
				if (step.is_selected === false) {
					newStepArray.push(step);
				}
			});
		
			newStepArray.forEach(task => {
				console.log(task);
			});
		
			task.steps = newStepArray;
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		
		const data1 = [{"id":1,"title":"Task 1","description":"Complete assignment","checked":false,"is_selected":false,"steps":[]},{"id":2,"title":"Task 2","description":"Buy groceries","checked":false,"is_selected":false,"steps":[{"description":"sdfsd","checked":false},{"description":"sdfsd","checked":false},{"description":"sdfsd","checked":false},{"description":"sdfsd","checked":false}]},{"id":3,"title":"Task 3","description":"Schedule dentist appointment","checked":false,"is_selected":false,"steps":[]},{"id":4,"title":"Task 4","description":"Call mom","checked":false,"is_selected":false,"steps":[]},{"id":5,"title":"Task 5","description":"Read a book","checked":false,"is_selected":false,"steps":[]}];
		// localStorage.setItem("tasks", JSON.stringify(data1));
		

		const selectTask = (taskId) => {
			const sTask = document.querySelector(`#selectTask${taskId}`);
			const tId = sTask.id.replace("selectTask", "") - 1;
			const task = taskArray[tId];
		
			task.is_selected = sTask.checked;
			
			const taskLi = document.querySelector(`#task${taskId}`).parentElement;
			taskLi.classList.toggle("bg-blue-400");
			const taskNoSpan = document.querySelector("#selectedTasksNo");
		
			if (selectedTaskArray.length > 0) {
				taskNoSpan.innerHTML = selectedTaskArray.length;
				taskNoSpan.classList.add("p-2");
			} else {
				taskNoSpan.innerHTML = "";
				taskNoSpan.classList.remove("p-2");
			}
		
		
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		
		const selectStep = (stepIndex) => {
			const StepB = document.querySelector(`#selectStep${stepIndex}`);
			const sTask = taskArray[selectedTaskId.replace("task", "") - 1];
			const step = sTask.steps[stepIndex];
			step.is_selected = StepB.checked;
		
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		

		const tasksUl = document.querySelector("#tasksUl");

		const createTaskHTML = (task) => {
			let checked = "";
			let line = "";
			let select = "";
			let bg = "";
		
			if (task.checked) {
				checked = "checked";
				line = "line-through"
			}
		
			if (task.is_selected) {
				select = "checked";
				bg = "bg-blue-400";
			}
		
			const taskHTML = `
			<li id="taskCont${task.id}" class="flex items-center justify-between p-2 m-2 rounded-xl bg-opacity-80 ${bg}">
				<input type="checkbox" onclick="selectTask(${task.id})" id="selectTask${task.id}" ${select}>
				<button data-target="steps${task.id}" id="task${task.id}" class="${line}">${task.title}</button>
				<div>
					<input type="checkbox" onchange="checkTask(${task.id})" id="markTask${task.id}" ${checked}>
					<button onclick="deleteTask('${encodeURIComponent(JSON.stringify(task))}')" id="deleteTask${task.id}" class="p-2 m-1 rounded-xl bg-red-600 hover:bg-red-500">Delete</button>
				</div>
			</li>
			`
			return taskHTML;
		}
		
		const displayTasksHTML = (taskArray) => {
			let displayHTML = "";
			taskArray.forEach(task => {
				displayHTML += createTaskHTML(task);
			});
			return displayHTML;
		}
		
		tasksUl.innerHTML = displayTasksHTML(taskArray);
		
		const addTask = () => {
			const title = document.querySelector("#taskTitle").value;
			const description = document.querySelector("#taskDescription").value;
			storeTask(title, description);
			displayTasksHTML(taskArray);
			location.reload();
		}
		
		const tasks = document.querySelectorAll('button[id^="task"]');
		const addStepBtn = document.querySelector("#addStepBtn");
		const stepsUl = document.querySelector("#stepsUl");
		const clickTask = document.querySelector("#clickTask");
		
		tasks.forEach(task => {
			task.addEventListener("click", () => {
				tasks.forEach(task => {
					task.parentElement.classList.remove("bg-green-400");
				});
				
				let taskLi = task.parentElement;
				let taskId = task.id.replace("task", "");
				let tskId = 0;
		
				taskLi.classList.add("bg-green-400");
				stepsUl.id = `steps${taskId}`;
		
				taskArray.forEach((task, index) => {
					if (task.id === Number(taskId)) {
						tskId  = index;
					}
				});
		
				stepsUl.innerHTML = displayStepsHTML(taskArray[tskId].steps);
				selectedTaskId = taskLi.children[1].id;
				clickTask.classList.add("hidden");
				addStepBtn.classList.remove("cursor-not-allowed");
				addStepBtn.disabled = false;
			});
		});
		

		const createStepHTML = (step, index) => {
			let checked = "";
			let line = "";
			let select = "";
			let bg = "";
		
			if (step.checked) {
				checked = "checked";
				line = "line-through";
			}
		
			if (step.is_selected) {
				select = "checked";
				bg = "bg-blue-400";
			}
		
			const stepHTML = `
				<li class="flex items-center justify-between p-2 m-2 rounded-xl bg-opacity-80 ${bg}">
					<input type="checkbox" id="selectStep${index}" onclick="selectStep(${index})" ${select}>
					<span class="${line} cursor-pointer">${step.description}</span>
					<div>
						<input type="checkbox" onchange="checkStep(${index})" id="markStep${index}" ${checked}>
						<button onclick="deleteStep(${index})" id="deleteStep${index}" class="p-2 m-1 rounded-xl bg-red-600 hover:bg-red-500">Delete</button>
					</div>
				</li>
				`;
			return stepHTML;
		}
		
		const displayStepsHTML = (steps) => {
			let displayHTML = "";
		
			if (steps.length > 0) {
				steps.forEach((step, index) => {
					displayHTML += createStepHTML(step, index);
				});
			} else {
				displayHTML = "This task has no steps.";
			}
			return displayHTML;
		}
		
		const addStep = () => {
			const description = document.querySelector("#stepDescription").value;
			storeStep(description);
			location.reload();
		}
		

		const deleteTask = (taskstr) => {
			const dTask = JSON.parse(decodeURIComponent(taskstr));
		
			taskArray.forEach((task, index) => {
				if (task.id == dTask.id) {
					taskArray.splice(index, 1);
				}
			});
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}


		const deleteStep = (stepIndex) => {
			const taskClicked = taskArray[selectedTaskId.replace("task", "")];
			const stepsArray = taskClicked.steps;
			const indexEnd = stepIndex > 0 ? stepIndex + 1 : 1;
			stepsArray.splice(stepIndex, indexEnd);
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		

		const tasksDropsideMenu = document.querySelector("#tasksDropsideToggler");
		const tasksDropsideOptions = document.querySelector("#tasksDropsideOptions");
		const openTasksMenu = document.querySelector("#openTasksMenu");
		const closeTasksMenu = document.querySelector("#closeTasksMenu");
		
		const stepsDropsideMenu = document.querySelector("#stepsDropsideToggler");
		const stepsDropsideOptions = document.querySelector("#stepsDropsideOptions");
		const openStepsMenu = document.querySelector("#openStepsMenu");
		const closeStepsMenu = document.querySelector("#closeStepsMenu");
		
		tasksDropsideMenu.addEventListener("click", () => {
			tasksDropsideOptions.classList.toggle("hidden");
			tasksDropsideOptions.classList.toggle("flex");
			closeTasksMenu.classList.toggle("hidden");
			openTasksMenu.classList.toggle("hidden");
		});
		
		stepsDropsideMenu.addEventListener("click", () => {
			stepsDropsideOptions.classList.toggle("hidden");
			stepsDropsideOptions.classList.toggle("flex");
			closeStepsMenu.classList.toggle("hidden");
			openStepsMenu.classList.toggle("hidden");
		});
		

		const checkTask = (taskId) => {
			const checkbox = document.querySelector(`#markTask${taskId}`);
			const checkVal = checkbox.checked;
			const task = taskArray[taskId];
			checkVal ? task.checked = checkVal : task.checked = false;
			const tskId = "task" + taskId;
			const taskBtn = document.querySelector(`#${tskId}`);
			taskBtn.classList.toggle("line-through");
			localStorage.setItem("tasks", JSON.stringify(taskArray));
		}
		

		const checkStep = (stepIndex) => {
			const stepCheck = document.querySelector(`#markStep${stepIndex}`).checked;
			const step = taskArray[selectedTaskId.replace("task", "") - 1].steps[stepIndex];
			step.checked = stepCheck;
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		
		const markSelectedTasks = () => {
			selectedTaskArray.forEach(sTask => {
				sTask.checked = true;
			});
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		
		const markSelectedSteps = () => {
			const task = taskArray[selectedTaskId.replace("task", "") - 1];
			const selectedStepsIdArray = [];
		
			taskArray.forEach(task => {
				task.steps.forEach((step, index) => {
					if (step.is_selected) {
						selectedStepsIdArray.push(index);
					}
				});
			});
		
			selectedStepsIdArray.forEach(sStep => {
				console.log(sStep);
			});
			
			task.steps.forEach(step => {
				selectedStepsIdArray.forEach(sStepId => {
					if (step === task.steps[sStepId]) {
						step.checked = true;
					}
				});
			});
		
			localStorage.setItem("tasks", JSON.stringify(taskArray));
			location.reload();
		}
		

		const modalBtns = document.querySelectorAll("button[data-modal]");

		modalBtns.forEach(button => {
			button.addEventListener("click", () => {
				const modalId = button.dataset.modal;
				const modal = document.querySelector(`#${modalId}`);
				const closeButtons = modal.querySelectorAll(`[data-modal="${modalId}"]`);
		
				modal.classList.remove("hidden");
				modal.classList.add("flex");
		
				closeButtons.forEach(closeButton => {
					closeButton.addEventListener("click", () => {
						modal.classList.add("hidden");
					});
				});
			});
		});
		
	</script>

	<!--
		<script src="./../js/toggleSteps.js"></script>
		<script src="./../js/progressBar.js"></script> 
	-->
</body>

</html>
